// Translations for Products Page
const translations = {
    fr: {
        menu: "Menu",
        produit: "Produit",
        games: "Mini Jeux",
        history: "Histoire",
        contact: "Contact",
        profile: "Profil",
        logout: "DÃ©connexion",
        productsTitle: "Nos Produits Indumilk",
        profileName: "Nom: Utilisateur InvitÃ©",
        profileEmail: "Email: guest@indumilk.com",
        profileMember: "Membre depuis: 2024",
        orderHistoryTitle: "Historique des commandes",
        orderHistoryEmpty: "Aucune commande rÃ©cente",
        logoutSuccess: "DÃ©connexion rÃ©ussie!",
        logoutConfirm: "ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter?",
        logoutInProgress: "DÃ©connexion en cours...",
        dairy: "Laitier",
        cheese: "Fromage",
        premium: "Premium",
        all: "Tous",
        featuredTitle: "Produit du Mois",
        featuredDescription: "Notre lait frais de qualitÃ© supÃ©rieure, directement de nos fermes partenaires.",
        addToCart: "Ajouter au Panier",
        favorites: "Favoris",
        productDetails: "DÃ©tails du Produit:",
        origin: "Origine: Fermes locales",
        expiry: "DurÃ©e de conservation: 7 jours",
        storage: "Conservation: RÃ©frigÃ©rateur",
        cart: "Panier",
        cartEmpty: "Votre panier est vide",
        total: "Total",
        checkout: "Commander",
        quantity: "QuantitÃ©"
    },
    en: {
        menu: "Menu",
        produit: "Products",
        games: "Mini Games",
        history: "History",
        contact: "Contact",
        profile: "Profile",
        logout: "Logout",
        productsTitle: "Our Indumilk Products",
        profileName: "Name: Guest User",
        profileEmail: "Email: guest@indumilk.com",
        profileMember: "Member since: 2024",
        orderHistoryTitle: "Order History",
        orderHistoryEmpty: "No recent orders",
        logoutSuccess: "Logout successful!",
        logoutConfirm: "Are you sure you want to logout?",
        logoutInProgress: "Logging out...",
        dairy: "Dairy",
        cheese: "Cheese",
        premium: "Premium",
        all: "All",
        featuredTitle: "Product of the Month",
        featuredDescription: "Our premium fresh milk, directly from our partner farms.",
        addToCart: "Add to Cart",
        favorites: "Favorites",
        productDetails: "Product Details:",
        origin: "Origin: Local farms",
        expiry: "Shelf life: 7 days",
        storage: "Storage: Refrigerator",
        cart: "Cart",
        cartEmpty: "Your cart is empty",
        total: "Total",
        checkout: "Order",
        quantity: "Quantity"
    },
    ar: {
        menu: "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
        produit: "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
        games: "Ø£Ù„Ø¹Ø§Ø¨ Ù…ØµØºØ±Ø©",
        history: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
        contact: "Ø§ØªØµÙ„",
        profile: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
        logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
        productsTitle: "Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù†Ø¯ÙˆÙ…ÙŠÙ„Ùƒ",
        profileName: "Ø§Ù„Ø§Ø³Ù…: Ù…Ø³ØªØ®Ø¯Ù… Ø¶ÙŠÙ",
        profileEmail: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: guest@indumilk.com",
        profileMember: "Ø¹Ø¶Ùˆ Ù…Ù†Ø°: 2024",
        orderHistoryTitle: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
        orderHistoryEmpty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø¯ÙŠØ«Ø©",
        logoutSuccess: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!",
        logoutConfirm: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ",
        logoutInProgress: "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...",
        dairy: "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ù„Ø¨Ø§Ù†",
        cheese: "Ø¬Ø¨Ù†",
        premium: "ÙØ§Ø®Ø±",
        all: "Ø§Ù„ÙƒÙ„",
        featuredTitle: "Ù…Ù†ØªØ¬ Ø§Ù„Ø´Ù‡Ø±",
        featuredDescription: "Ø­Ù„ÙŠØ¨Ù†Ø§ Ø§Ù„Ø·Ø§Ø²Ø¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ø²Ø§Ø±Ø¹Ù†Ø§ Ø§Ù„Ø´Ø±ÙŠÙƒØ©.",
        addToCart: "Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©",
        favorites: "Ø§Ù„Ù…ÙØ¶Ù„Ø©",
        productDetails: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬:",
        origin: "Ø§Ù„Ù…Ù†Ø´Ø£: Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠØ©",
        expiry: "Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: 7 Ø£ÙŠØ§Ù…",
        storage: "Ø§Ù„ØªØ®Ø²ÙŠÙ†: Ø§Ù„Ø«Ù„Ø§Ø¬Ø©",
        cart: "Ø§Ù„Ø³Ù„Ø©",
        cartEmpty: "Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©",
        total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",
        checkout: "Ø§Ø·Ù„Ø¨",
        quantity: "Ø§Ù„ÙƒÙ…ÙŠØ©"
    }
};

// Products data with multilingual names and descriptions
const products = [
    {
        id: 1,
        name: {
            fr: "Lait Frais Premium",
            en: "Premium Fresh Milk",
            ar: "Ø­Ù„ÙŠØ¨ Ø·Ø§Ø²Ø¬ ÙØ§Ø®Ø±"
        },
        description: {
            fr: "Lait frais de qualitÃ© supÃ©rieure, riche en vitamines et minÃ©raux essentiels.",
            en: "Premium fresh milk, rich in essential vitamins and minerals.",
            ar: "Ø­Ù„ÙŠØ¨ Ø·Ø§Ø²Ø¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ ØºÙ†ÙŠ Ø¨Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©."
        },
        price: 15,
        category: "dairy",
        image: "lait.jpg",
        featured: true
    },
    {
        id: 2,
        name: {
            fr: "Mozzarella Artisanale",
            en: "Artisan Mozzarella",
            ar: "Ù…ÙˆØªØ²Ø§Ø±ÙŠÙ„Ø§ Ø­Ø±ÙÙŠØ©"
        },
        description: {
            fr: "Mozzarella traditionnelle faite Ã  la main avec des techniques artisanales.",
            en: "Traditional handmade mozzarella using artisan techniques.",
            ar: "Ù…ÙˆØªØ²Ø§Ø±ÙŠÙ„Ø§ ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ù…ØµÙ†ÙˆØ¹Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨ØªÙ‚Ù†ÙŠØ§Øª Ø­Ø±ÙÙŠØ©."
        },
        price: 45,
        category: "cheese",
        image: "mozarella.jpg"
    },
    {
        id: 3,
        name: {
            fr: "CrÃ¨me FraÃ®che Premium",
            en: "Premium Fresh Cream",
            ar: "ÙƒØ±ÙŠÙ…Ø© Ø·Ø§Ø²Ø¬Ø© ÙØ§Ø®Ø±Ø©"
        },
        description: {
            fr: "CrÃ¨me fraÃ®che onctueuse parfaite pour vos prÃ©parations culinaires.",
            en: "Smooth fresh cream perfect for your culinary preparations.",
            ar: "ÙƒØ±ÙŠÙ…Ø© Ø·Ø§Ø²Ø¬Ø© Ù†Ø§Ø¹Ù…Ø© Ù…Ø«Ø§Ù„ÙŠØ© Ù„ØªØ­Ø¶ÙŠØ±Ø§ØªÙƒ Ø§Ù„Ø·Ù‡ÙˆÙŠØ©."
        },
        price: 25,
        category: "dairy",
        image: "creme.jpg"
    },
    {
        id: 4,
        name: {
            fr: "Ricotta DÃ©licate",
            en: "Delicate Ricotta",
            ar: "Ø±ÙŠÙƒÙˆØªØ§ Ø±Ù‚ÙŠÙ‚Ø©"
        },
        description: {
            fr: "Ricotta lÃ©gÃ¨re et crÃ©meuse, idÃ©ale pour les desserts et plats salÃ©s.",
            en: "Light and creamy ricotta, ideal for desserts and savory dishes.",
            ar: "Ø±ÙŠÙƒÙˆØªØ§ Ø®ÙÙŠÙØ© ÙˆÙƒØ±ÙŠÙ…ÙŠØ©ØŒ Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø­Ù„ÙˆÙŠØ§Øª ÙˆØ§Ù„Ø£Ø·Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø§Ù„Ø­Ø©."
        },
        price: 35,
        category: "cheese",
        image: "ricotta.png"
    },
    {
        id: 5,
        name: {
            fr: "Fromage Edam Traditionnel",
            en: "Traditional Edam Cheese",
            ar: "Ø¬Ø¨Ù† Ø¥ÙŠØ¯Ø§Ù… ØªÙ‚Ù„ÙŠØ¯ÙŠ"
        },
        description: {
            fr: "Fromage Edam vieilli selon les mÃ©thodes traditionnelles hollandaises.",
            en: "Edam cheese aged according to traditional Dutch methods.",
            ar: "Ø¬Ø¨Ù† Ø¥ÙŠØ¯Ø§Ù… Ù…Ø¹ØªÙ‚ ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ø·Ø±Ù‚ Ø§Ù„Ù‡ÙˆÙ„Ù†Ø¯ÙŠØ© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©."
        },
        price: 55,
        category: "premium",
        image: "fromage edam.jpg"
    },
    {
        id: 6,
        name: {
            fr: "Yaourt Nature Bio",
            en: "Organic Natural Yogurt",
            ar: "Ø²Ø¨Ø§Ø¯ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ Ø¹Ø¶ÙˆÙŠ"
        },
        description: {
            fr: "Yaourt nature biologique sans additifs, riche en probiotiques.",
            en: "Organic natural yogurt without additives, rich in probiotics.",
            ar: "Ø²Ø¨Ø§Ø¯ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ Ø¹Ø¶ÙˆÙŠ Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§ØªØŒ ØºÙ†ÙŠ Ø¨Ø§Ù„Ø¨Ø±ÙˆØ¨ÙŠÙˆØªÙŠÙƒ."
        },
        price: 12,
        category: "dairy",
        image: "yogurt.jpg"
    },
    {
        id: 9,
        name: {
            fr: "Petit Jean",
            en: "Petit Jean",
            ar: "Ø¨ÙŠØªÙŠ Ø¬Ø§Ù†"
        },
        description: {
            fr: "Fromage artisanal Petit Jean, doux et crÃ©meux, parfait pour les plateaux de fromages.",
            en: "Artisan Petit Jean cheese, mild and creamy, perfect for cheese boards.",
            ar: "Ø¬Ø¨Ù† Ø¨ÙŠØªÙŠ Ø¬Ø§Ù† Ø§Ù„Ø­Ø±ÙÙŠØŒ Ù†Ø§Ø¹Ù… ÙˆÙƒØ±ÙŠÙ…ÙŠØŒ Ù…Ø«Ø§Ù„ÙŠ Ù„Ø£Ø·Ø¨Ø§Ù‚ Ø§Ù„Ø¬Ø¨Ù†."
        },
        price: 28,
        category: "cheese",
        image: "https://images.pexels.com/photos/1070850/pexels-photo-1070850.jpeg?auto=compress&cs=tinysrgb&w=200"
    },
    {
        id: 7,
        name: {
            fr: "Beurre Fermier",
            en: "Farm Butter",
            ar: "Ø²Ø¨Ø¯Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø©"
        },
        description: {
            fr: "Beurre artisanal fait Ã  partir de crÃ¨me fraÃ®che de nos fermes.",
            en: "Artisan butter made from fresh cream from our farms.",
            ar: "Ø²Ø¨Ø¯Ø© Ø­Ø±ÙÙŠØ© Ù…ØµÙ†ÙˆØ¹Ø© Ù…Ù† Ø§Ù„ÙƒØ±ÙŠÙ…Ø© Ø§Ù„Ø·Ø§Ø²Ø¬Ø© Ù…Ù† Ù…Ø²Ø§Ø±Ø¹Ù†Ø§."
        },
        price: 28,
        category: "premium",
        image: "https://images.pexels.com/photos/248412/pexels-photo-248412.jpeg?auto=compress&cs=tinysrgb&w=200"
    },
    {
        id: 8,
        name: {
            fr: "Camembert de Normandie",
            en: "Normandy Camembert",
            ar: "ÙƒØ§Ù…Ø§Ù…Ø¨ÙŠØ± Ù†ÙˆØ±Ù…Ø§Ù†Ø¯ÙŠ"
        },
        description: {
            fr: "Camembert authentique avec sa croÃ»te fleurie et son cÅ“ur onctueux.",
            en: "Authentic camembert with its bloomy rind and creamy heart.",
            ar: "ÙƒØ§Ù…Ø§Ù…Ø¨ÙŠØ± Ø£ØµÙŠÙ„ Ø¨Ù‚Ø´Ø±ØªÙ‡ Ø§Ù„Ù…Ø²Ù‡Ø±Ø© ÙˆÙ„Ø¨Ù‡ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ."
        },
        price: 65,
        category: "premium",
        image: "https://images.pexels.com/photos/773253/pexels-photo-773253.jpeg?auto=compress&cs=tinysrgb&w=200"
    }
];

// State variables
let currentLang = 'fr';
let isDarkMode = false;
let cart = [];
let favorites = [];
let currentFilter = 'all';
let selectedProduct = null;

// Initialize the application
function init() {
    loadSettings();
    loadUserProfile();
    populateProducts();
    updateLanguage();
    setupEventListeners();
    updateFeaturedProduct();
}

// Load saved settings
function loadSettings() {
    const savedLang = localStorage.getItem('selectedLanguage');
    if (savedLang && translations[savedLang]) {
        currentLang = savedLang;
    }

    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === 'enabled') {
        isDarkMode = true;
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) toggle.textContent = 'â˜€ï¸';
    }

    const savedCart = localStorage.getItem('cart');
    if (savedCart) {
        try {
            cart = JSON.parse(savedCart);
            updateCartCount();
        } catch (e) {
            cart = [];
        }
    }

    const savedFavorites = localStorage.getItem('favorites');
    if (savedFavorites) {
        try {
            favorites = JSON.parse(savedFavorites);
        } catch (e) {
            favorites = [];
        }
    }
}

// Load user profile information
function loadUserProfile() {
    try {
        const currentUser = JSON.parse(localStorage.getItem('indumilk_currentUser'));
        if (currentUser) {
            updateProfileDisplay(currentUser);
        }
    } catch (e) {
        console.log('No user data found, using guest profile');
    }
}

// Update profile display with actual user data
function updateProfileDisplay(user) {
    const t = translations[currentLang];
    const profileInfo = document.getElementById('profileInfo');
    if (profileInfo && user) {
        const memberSince = user.createdAt ? new Date(user.createdAt).getFullYear() : '2024';
        profileInfo.innerHTML = `
            <p>${t.profileName.replace('Utilisateur InvitÃ©', user.name || 'Utilisateur InvitÃ©').replace('Guest User', user.name || 'Guest User').replace('Ù…Ø³ØªØ®Ø¯Ù… Ø¶ÙŠÙ', user.name || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¶ÙŠÙ')}</p>
            <p>${t.profileEmail.replace('guest@indumilk.com', user.email || 'guest@indumilk.com')}</p>
            <p>${t.profileMember.replace('2024', memberSince)}</p>
        `;
    }
}

// Setup event listeners
function setupEventListeners() {
    // Category filter buttons
    document.querySelectorAll('.filterBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            currentFilter = e.target.dataset.category;
            updateFilterButtons();
            populateProducts();
        });
    });

    // Close modal when clicking outside
    const productModal = document.getElementById('productModal');
    if (productModal) {
        productModal.addEventListener('click', (e) => {
            if (e.target === productModal) {
                closeProductModal();
            }
        });
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        const langSelect = document.querySelector('.langSelect');
        const dropdown = document.getElementById('langDropdown');

        if (langSelect && dropdown && !langSelect.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });
}

// Update filter buttons
function updateFilterButtons() {
    document.querySelectorAll('.filterBtn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === currentFilter) {
            btn.classList.add('active');
        }
    });
}

// Populate products grid
function populateProducts() {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    productsGrid.innerHTML = '';

    const filteredProducts = currentFilter === 'all' 
        ? products 
        : products.filter(product => product.category === currentFilter);

    filteredProducts.forEach(product => {
        const productCard = createProductCard(product);
        productsGrid.appendChild(productCard);
    });
}

// Create product card
function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'productCard';
    card.onclick = () => openProductModal(product);

    const isFavorite = favorites.includes(product.id);
    const t = translations[currentLang];

    card.innerHTML = `
        <img src="${product.image}" alt="${product.name[currentLang]}" class="productImage" 
             onerror="this.src='https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=200'">
        <div class="productName">${product.name[currentLang]}</div>
        <div class="productPrice">${product.price} DH</div>
        <div class="productCategory">${getCategoryName(product.category)}</div>
        <div class="productActions">
            <button class="addToCartBtn" onclick="event.stopPropagation(); addToCart(${product.id})">
                ${t.addToCart}
            </button>
            <button class="favoriteBtn ${isFavorite ? 'active' : ''}" 
                    onclick="event.stopPropagation(); toggleFavorite(${product.id})">
                â¤ï¸
            </button>
        </div>
    `;

    return card;
}

// Get category name in current language
function getCategoryName(category) {
    const t = translations[currentLang];
    switch(category) {
        case 'dairy': return t.dairy;
        case 'cheese': return t.cheese;
        case 'premium': return t.premium;
        default: return category;
    }
}

// Update featured product
function updateFeaturedProduct() {
    const featuredProduct = products.find(p => p.featured) || products[0];
    const t = translations[currentLang];

    const elements = {
        'featuredImage': { src: featuredProduct.image },
        'featuredTitle': { textContent: t.featuredTitle },
        'featuredName': { textContent: featuredProduct.name[currentLang] },
        'featuredDescription': { textContent: featuredProduct.description[currentLang] },
        'featuredPrice': { textContent: `${featuredProduct.price} DH` },
        'featuredBtn': { textContent: t.addToCart }
    };

    Object.entries(elements).forEach(([id, props]) => {
        const element = document.getElementById(id);
        if (element) {
            Object.entries(props).forEach(([prop, value]) => {
                if (prop === 'src') {
                    element.src = value;
                    element.onerror = function() {
                        this.src = 'https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=400';
                    };
                } else {
                    element[prop] = value;
                }
            });
        }
    });

    const featuredBtn = document.getElementById('featuredBtn');
    if (featuredBtn) {
        featuredBtn.onclick = () => addToCart(featuredProduct.id);
    }
}

// Open product modal
function openProductModal(product) {
    selectedProduct = product;
    const t = translations[currentLang];
    const isFavorite = favorites.includes(product.id);

    const elements = {
        'modalImage': { src: product.image },
        'modalTitle': { textContent: product.name[currentLang] },
        'modalDescription': { textContent: product.description[currentLang] },
        'modalPrice': { textContent: `${product.price} DH` },
        'modalDetailsTitle': { textContent: t.productDetails },
        'modalOrigin': { textContent: t.origin },
        'modalExpiry': { textContent: t.expiry },
        'modalStorage': { textContent: t.storage },
        'modalAddBtn': { textContent: t.addToCart },
        'modalFavoriteBtn': { textContent: `â¤ï¸ ${t.favorites}` }
    };

    Object.entries(elements).forEach(([id, props]) => {
        const element = document.getElementById(id);
        if (element) {
            Object.entries(props).forEach(([prop, value]) => {
                if (prop === 'src') {
                    element.src = value;
                    element.onerror = function() {
                        this.src = 'https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=400';
                    };
                } else {
                    element[prop] = value;
                }
            });
        }
    });

    const modalFavoriteBtn = document.getElementById('modalFavoriteBtn');
    if (modalFavoriteBtn) {
        modalFavoriteBtn.className = `modalFavoriteBtn ${isFavorite ? 'active' : ''}`;
        modalFavoriteBtn.onclick = () => toggleFavorite(product.id);
    }

    const modalAddBtn = document.getElementById('modalAddBtn');
    if (modalAddBtn) {
        modalAddBtn.onclick = () => {
            addToCart(product.id);
            closeProductModal();
        };
    }

    const modal = document.getElementById('productModal');
    if (modal) modal.classList.add('show');
}

// Close product modal
function closeProductModal() {
    const modal = document.getElementById('productModal');
    if (modal) modal.classList.remove('show');
    selectedProduct = null;
}

// Add to cart
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: productId,
            name: product.name[currentLang],
            price: product.price,
            image: product.image,
            quantity: 1
        });
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    updateCartDisplay();

    // Show success feedback
    showNotification(translations[currentLang].addToCart + ' âœ“');
}

// Toggle favorite
function toggleFavorite(productId) {
    const index = favorites.indexOf(productId);
    if (index > -1) {
        favorites.splice(index, 1);
    } else {
        favorites.push(productId);
    }

    localStorage.setItem('favorites', JSON.stringify(favorites));
    populateProducts(); // Refresh to update heart icons

    if (selectedProduct && selectedProduct.id === productId) {
        openProductModal(selectedProduct); // Refresh modal if open
    }
}

// Update cart count
function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const cartCount = document.getElementById('cartCount');
    if (cartCount) cartCount.textContent = totalItems;
}

// Update cart display
function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    if (!cartItems || !cartTotal) return;
    
    const t = translations[currentLang];

    if (cart.length === 0) {
        cartItems.innerHTML = `<p id="cartEmpty">${t.cartEmpty}</p>`;
        cartTotal.textContent = `${t.total}: 0 DH`;
        return;
    }

    let html = '';
    let total = 0;

    cart.forEach(item => {
        total += item.price * item.quantity;
        html += `
            <div class="cartItem">
                <img src="${item.image}" alt="${item.name}" class="cartItemImage" 
                     onerror="this.src='https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=100'">
                <div class="cartItemInfo">
                    <div class="cartItemName">${item.name}</div>
                    <div class="cartItemPrice">${item.price} DH</div>
                    <div class="cartItemQuantity">
                        <button class="quantityBtn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantityBtn" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                </div>
            </div>
        `;
    });

    cartItems.innerHTML = html;
    cartTotal.textContent = `${t.total}: ${total} DH`;
}

// Update quantity
function updateQuantity(productId, change) {
    const item = cart.find(item => item.id === productId);
    if (!item) return;

    item.quantity += change;
    if (item.quantity <= 0) {
        cart = cart.filter(cartItem => cartItem.id !== productId);
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    updateCartDisplay();
}

// Toggle cart sidebar
function toggleCart() {
    const cartSidebar = document.getElementById('cartSidebar');
    if (cartSidebar) {
        cartSidebar.classList.toggle('show');
        updateCartDisplay();
    }
}

// Show notification
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(40,167,69,0.4);
        z-index: 5000;
        font-weight: 600;
        animation: slideIn 0.4s ease;
        backdrop-filter: blur(20px);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 2500);
}

// Language functions
function toggleLangDropdown() {
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) dropdown.classList.toggle('show');
}

function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('selectedLanguage', lang);
    updateLanguage();
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) dropdown.classList.remove('show');
}

function updateLanguage() {
    const t = translations[currentLang];

    // Update navigation
    const navElements = {
        'btn-menu': t.menu,
        'btn-produit': t.produit,
        'btn-games': t.games,
        'btn-history': t.history,
        'btn-contact': t.contact,
        'productsTitle': t.productsTitle,
        'profileTitle': t.profile,
        'logoutBtn': t.logout,
        'filterAll': t.all,
        'filterDairy': t.dairy,
        'filterCheese': t.cheese,
        'filterPremium': t.premium,
        'cartTitle': t.cart,
        'checkoutBtn': t.checkout
    };

    Object.entries(navElements).forEach(([id, text]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = text;
    });

    // Update profile info
    const profileInfo = document.getElementById('profileInfo');
    if (profileInfo) {
        // Re-load user profile with new language
        loadUserProfile();
    }

    // Update order history
    const orderHistory = document.getElementById('orderHistory');
    if (orderHistory) {
        orderHistory.innerHTML = `
            <h3>${t.orderHistoryTitle}</h3>
            <p>${t.orderHistoryEmpty}</p>
        `;
    }

    // Update products and featured product
    populateProducts();
    updateFeaturedProduct();
    updateCartDisplay();

    // Handle RTL for Arabic
    if (currentLang === 'ar') {
        document.body.setAttribute('dir', 'rtl');
        document.body.style.fontFamily = 'Arial, Tahoma, sans-serif';
    } else {
        document.body.setAttribute('dir', 'ltr');
        document.body.style.fontFamily = 'Inter, Segoe UI, sans-serif';
    }
}

// Dark mode toggle
function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');

    const toggle = document.getElementById('darkModeToggle');
    if (toggle) {
        toggle.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
}

// Account functions
function showAccount() {
    const slide = document.getElementById('accountSlide');
    if (slide) slide.classList.add('show');
}

function closeAccount() {
    const slide = document.getElementById('accountSlide');
    if (slide) slide.classList.remove('show');
}

// UNIFIED LOGOUT FUNCTION - Redirects to authentication page
function logout() {
    const t = translations[currentLang];
    const logoutBtn = document.getElementById('logoutBtn');
    if (!logoutBtn) return;
    
    // Show confirmation dialog
    if (!confirm(t.logoutConfirm)) {
        return;
    }
    
    // Show loading state
    const originalText = logoutBtn.textContent;
    logoutBtn.textContent = t.logoutInProgress;
    logoutBtn.disabled = true;
    logoutBtn.style.opacity = '0.7';
    
    // Clear all user-related data
    localStorage.removeItem('indumilk_currentUser');
    localStorage.removeItem('indumilk_session');
    localStorage.removeItem('indumilk_token');
    localStorage.removeItem('userPreferences');
    
    // Simulate logout process
    setTimeout(() => {
        // Show success state briefly
        logoutBtn.textContent = t.logoutSuccess;
        logoutBtn.style.backgroundColor = '#4CAF50';
        
        // Close account slide
        closeAccount();
        
        // Redirect to authentication page
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 800);
    }, 1000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', init);