// Translations for History Page
const translations = {
    fr: {
        menu: "Menu",
        produit: "Produit",
        games: "Mini Jeux",
        history: "Histoire",
        contact: "Contact",
        profile: "Profil",
        logout: "D√©connexion",
        pageTitle: "Historique des Commandes",
        profileName: "Nom: Utilisateur Invit√©",
        profileEmail: "Email: guest@indumilk.com",
        profileMember: "Membre depuis: 2024",
        orderHistoryTitle: "Historique des commandes",
        orderHistoryEmpty: "Aucune commande r√©cente",
        logoutSuccess: "D√©connexion r√©ussie!",
        logoutConfirm: "√ätes-vous s√ªr de vouloir vous d√©connecter?",
        logoutInProgress: "D√©connexion en cours...",
        totalOrdersLabel: "Total des Commandes",
        totalSpentLabel: "Total D√©pens√©",
        favoriteItemLabel: "Article Pr√©f√©r√©",
        averageOrderLabel: "Commande Moyenne",
        searchPlaceholder: "Rechercher des commandes...",
        dateFilterLabel: "Filtrer par p√©riode:",
        statusFilterLabel: "Filtrer par statut:",
        sortByLabel: "Trier par:",
        clearFiltersBtn: "Effacer les filtres",
        exportBtn: "Exporter",
        refreshBtn: "Actualiser",
        ordersSectionTitle: "Vos Commandes",
        noOrdersTitle: "Aucune commande trouv√©e",
        noOrdersText: "Vous n'avez pas encore pass√© de commandes ou aucune commande ne correspond aux filtres s√©lectionn√©s.",
        orderNowBtn: "Commander maintenant",
        modalTitle: "D√©tails de la Commande",
        orderNumber: "Commande #",
        orderDate: "Date:",
        orderStatus: "Statut:",
        orderTotal: "Total:",
        completed: "Termin√©",
        pending: "En attente",
        cancelled: "Annul√©",
        processing: "En cours",
        shipped: "Exp√©di√©",
        delivered: "Livr√©",
        allPeriods: "Toutes les p√©riodes",
        today: "Aujourd'hui",
        thisWeek: "Cette semaine",
        thisMonth: "Ce mois",
        thisYear: "Cette ann√©e",
        last30Days: "30 derniers jours",
        last90Days: "90 derniers jours",
        allStatuses: "Tous les statuts",
        quantity: "Quantit√©:",
        price: "Prix:",
        subtotal: "Sous-total:",
        viewDetails: "Voir les d√©tails",
        addToFavorites: "Ajouter aux favoris",
        removeFromFavorites: "Retirer des favoris",
        sortNewest: "Plus r√©cent",
        sortOldest: "Plus ancien",
        sortHighest: "Montant le plus √©lev√©",
        sortLowest: "Montant le plus bas",
        itemsCount: "articles",
        showingResults: "Affichage de {count} r√©sultats"
    },
    en: {
        menu: "Menu",
        produit: "Products",
        games: "Mini Games",
        history: "History",
        contact: "Contact",
        profile: "Profile",
        logout: "Logout",
        pageTitle: "Order History",
        profileName: "Name: Guest User",
        profileEmail: "Email: guest@indumilk.com",
        profileMember: "Member since: 2024",
        orderHistoryTitle: "Order History",
        orderHistoryEmpty: "No recent orders",
        logoutSuccess: "Logout successful!",
        logoutConfirm: "Are you sure you want to logout?",
        logoutInProgress: "Logging out...",
        totalOrdersLabel: "Total Orders",
        totalSpentLabel: "Total Spent",
        favoriteItemLabel: "Favorite Item",
        averageOrderLabel: "Average Order",
        searchPlaceholder: "Search orders...",
        dateFilterLabel: "Filter by period:",
        statusFilterLabel: "Filter by status:",
        sortByLabel: "Sort by:",
        clearFiltersBtn: "Clear filters",
        exportBtn: "Export",
        refreshBtn: "Refresh",
        ordersSectionTitle: "Your Orders",
        noOrdersTitle: "No orders found",
        noOrdersText: "You haven't placed any orders yet or no orders match the selected filters.",
        orderNowBtn: "Order now",
        modalTitle: "Order Details",
        orderNumber: "Order #",
        orderDate: "Date:",
        orderStatus: "Status:",
        orderTotal: "Total:",
        completed: "Completed",
        pending: "Pending",
        cancelled: "Cancelled",
        processing: "Processing",
        shipped: "Shipped",
        delivered: "Delivered",
        allPeriods: "All periods",
        today: "Today",
        thisWeek: "This week",
        thisMonth: "This month",
        thisYear: "This year",
        last30Days: "Last 30 days",
        last90Days: "Last 90 days",
        allStatuses: "All statuses",
        quantity: "Quantity:",
        price: "Price:",
        subtotal: "Subtotal:",
        viewDetails: "View Details",
        addToFavorites: "Add to Favorites",
        removeFromFavorites: "Remove from Favorites",
        sortNewest: "Newest first",
        sortOldest: "Oldest first",
        sortHighest: "Highest amount",
        sortLowest: "Lowest amount",
        itemsCount: "items",
        showingResults: "Showing {count} results"
    },
    ar: {
        menu: "ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
        produit: "ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™",
        games: "ÿ£ŸÑÿπÿßÿ® ŸÖÿµÿ∫ÿ±ÿ©",
        history: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ",
        contact: "ÿßÿ™ÿµŸÑ",
        profile: "ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä",
        logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
        pageTitle: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",
        profileName: "ÿßŸÑÿßÿ≥ŸÖ: ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∂ŸäŸÅ",
        profileEmail: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: guest@indumilk.com",
        profileMember: "ÿπÿ∂Ÿà ŸÖŸÜÿ∞: 2024",
        orderHistoryTitle: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",
        orderHistoryEmpty: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ≠ÿØŸäÿ´ÿ©",
        logoutSuccess: "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠!",
        logoutConfirm: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü",
        logoutInProgress: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨...",
        totalOrdersLabel: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",
        totalSpentLabel: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖŸÜŸÅŸÇ",
        favoriteItemLabel: "ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑŸÖŸÅÿ∂ŸÑ",
        averageOrderLabel: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ∑ŸÑÿ®",
        searchPlaceholder: "ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™...",
        dateFilterLabel: "ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ™ÿ±ÿ©:",
        statusFilterLabel: "ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©:",
        sortByLabel: "ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ®:",
        clearFiltersBtn: "ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™",
        exportBtn: "ÿ™ÿµÿØŸäÿ±",
        refreshBtn: "ÿ™ÿ≠ÿØŸäÿ´",
        ordersSectionTitle: "ÿ∑ŸÑÿ®ÿßÿ™ŸÉ",
        noOrdersTitle: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ∑ŸÑÿ®ÿßÿ™",
        noOrdersText: "ŸÑŸÖ ÿ™ŸÇŸÖ ÿ®ÿ™ŸÇÿØŸäŸÖ ÿ£Ÿä ÿ∑ŸÑÿ®ÿßÿ™ ÿ®ÿπÿØ ÿ£Ÿà ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÖÿ±ÿ¥ÿ≠ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©.",
        orderNowBtn: "ÿßÿ∑ŸÑÿ® ÿßŸÑÿ¢ŸÜ",
        modalTitle: "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®",
        orderNumber: "ÿ∑ŸÑÿ® #",
        orderDate: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:",
        orderStatus: "ÿßŸÑÿ≠ÿßŸÑÿ©:",
        orderTotal: "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ:",
        completed: "ŸÖŸÉÿ™ŸÖŸÑ",
        pending: "ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±",
        cancelled: "ŸÖŸÑÿ∫Ÿä",
        processing: "ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©",
        shipped: "ÿ™ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ",
        delivered: "ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ",
        allPeriods: "ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™",
        today: "ÿßŸÑŸäŸàŸÖ",
        thisWeek: "Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ",
        thisMonth: "Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±",
        thisYear: "Ÿáÿ∞ÿß ÿßŸÑÿπÿßŸÖ",
        last30Days: "ÿ¢ÿÆÿ± 30 ŸäŸàŸÖÿßŸã",
        last90Days: "ÿ¢ÿÆÿ± 90 ŸäŸàŸÖÿßŸã",
        allStatuses: "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™",
        quantity: "ÿßŸÑŸÉŸÖŸäÿ©:",
        price: "ÿßŸÑÿ≥ÿπÿ±:",
        subtotal: "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä:",
        viewDetails: "ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ",
        addToFavorites: "ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ©",
        removeFromFavorites: "ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©",
        sortNewest: "ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã",
        sortOldest: "ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã",
        sortHighest: "ÿ£ÿπŸÑŸâ ŸÖÿ®ŸÑÿ∫",
        sortLowest: "ÿ£ŸÇŸÑ ŸÖÿ®ŸÑÿ∫",
        itemsCount: "ÿπŸÜÿßÿµÿ±",
        showingResults: "ÿπÿ±ÿ∂ {count} ŸÜÿ™ÿßÿ¶ÿ¨"
    }
};

// Sample order data
const sampleOrders = [
    {
        id: 2001,
        date: new Date('2024-01-15'),
        status: 'completed',
        items: [
            { id: 1, name: { fr: "Lait Frais Premium", en: "Premium Fresh Milk", ar: "ÿ≠ŸÑŸäÿ® ÿ∑ÿßÿ≤ÿ¨ ŸÅÿßÿÆÿ±" }, quantity: 2, price: 15, image: "lait.jpg" },
            { id: 2, name: { fr: "Mozzarella Artisanale", en: "Artisan Mozzarella", ar: "ŸÖŸàÿ™ÿ≤ÿßÿ±ŸäŸÑÿß ÿ≠ÿ±ŸÅŸäÿ©" }, quantity: 1, price: 45, image: "mozarella.jpg" }
        ],
        total: 75,
        trackingNumber: "TRK001234567"
    },
    {
        id: 2002,
        date: new Date('2024-01-10'),
        status: 'shipped',
        items: [
            { id: 3, name: { fr: "Cr√®me Fra√Æche Premium", en: "Premium Fresh Cream", ar: "ŸÉÿ±ŸäŸÖÿ© ÿ∑ÿßÿ≤ÿ¨ÿ© ŸÅÿßÿÆÿ±ÿ©" }, quantity: 1, price: 25, image: "creme.jpg" },
            { id: 6, name: { fr: "Yaourt Nature Bio", en: "Organic Natural Yogurt", ar: "ÿ≤ÿ®ÿßÿØŸä ÿ∑ÿ®ŸäÿπŸä ÿπÿ∂ŸàŸä" }, quantity: 3, price: 12, image: "yogurt.jpg" }
        ],
        total: 61,
        trackingNumber: "TRK001234568"
    },
    {
        id: 2003,
        date: new Date('2024-01-05'),
        status: 'delivered',
        items: [
            { id: 4, name: { fr: "Ricotta D√©licate", en: "Delicate Ricotta", ar: "ÿ±ŸäŸÉŸàÿ™ÿß ÿ±ŸÇŸäŸÇÿ©" }, quantity: 1, price: 35, image: "ricotta.png" },
            { id: 5, name: { fr: "Fromage Edam", en: "Edam Cheese", ar: "ÿ¨ÿ®ŸÜ ÿ•ŸäÿØÿßŸÖ" }, quantity: 1, price: 55, image: "fromage edam.jpg" }
        ],
        total: 90,
        trackingNumber: "TRK001234569"
    },
    {
        id: 2004,
        date: new Date('2023-12-28'),
        status: 'pending',
        items: [
            { id: 1, name: { fr: "Lait Frais Premium", en: "Premium Fresh Milk", ar: "ÿ≠ŸÑŸäÿ® ÿ∑ÿßÿ≤ÿ¨ ŸÅÿßÿÆÿ±" }, quantity: 1, price: 15, image: "lait.jpg" }
        ],
        total: 15,
        trackingNumber: "TRK001234570"
    },
    {
        id: 2005,
        date: new Date('2023-12-20'),
        status: 'cancelled',
        items: [
            { id: 2, name: { fr: "Mozzarella Artisanale", en: "Artisan Mozzarella", ar: "ŸÖŸàÿ™ÿ≤ÿßÿ±ŸäŸÑÿß ÿ≠ÿ±ŸÅŸäÿ©" }, quantity: 2, price: 45, image: "mozarella.jpg" }
        ],
        total: 90,
        trackingNumber: "TRK001234571"
    }
];

// State variables
let currentLang = 'fr';
let isDarkMode = false;
let orders = [...sampleOrders];
let searchTerm = '';
let dateFilter = 'all';
let statusFilter = 'all';
let sortBy = 'newest';
let selectedOrder = null;
let favoriteProducts = new Set([1, 3, 5]);
let currentPage = 1;
const ordersPerPage = 6;

// Initialize the application
function init() {
    loadSettings();
    updateLanguage();
    setupEventListeners();
    updateSummaryCards();
    renderOrders();
    updatePagination();
}

// Load saved settings
function loadSettings() {
    const savedLang = localStorage.getItem('selectedLanguage');
    if (savedLang && translations[savedLang]) {
        currentLang = savedLang;
    }

    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === 'enabled') {
        isDarkMode = true;
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) toggle.textContent = '‚òÄÔ∏è';
    }

    const savedFavorites = localStorage.getItem('favoriteProducts');
    if (savedFavorites) {
        try {
            favoriteProducts = new Set(JSON.parse(savedFavorites));
        } catch (e) {
            favoriteProducts = new Set([1, 3, 5]);
        }
    }
}

// Setup event listeners
function setupEventListeners() {
    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            currentPage = 1;
            renderOrders();
            updatePagination();
        });
    }

    // Filter selects
    const dateFilterSelect = document.getElementById('dateFilter');
    if (dateFilterSelect) {
        dateFilterSelect.addEventListener('change', (e) => {
            dateFilter = e.target.value;
            currentPage = 1;
            renderOrders();
            updatePagination();
        });
    }

    const statusFilterSelect = document.getElementById('statusFilter');
    if (statusFilterSelect) {
        statusFilterSelect.addEventListener('change', (e) => {
            statusFilter = e.target.value;
            currentPage = 1;
            renderOrders();
            updatePagination();
        });
    }

    const sortBySelect = document.getElementById('sortBy');
    if (sortBySelect) {
        sortBySelect.addEventListener('change', (e) => {
            sortBy = e.target.value;
            renderOrders();
            updatePagination();
        });
    }

    // Close modal when clicking outside
    const modal = document.getElementById('transactionModal');
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeTransactionModal();
            }
        });
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        const langSelect = document.querySelector('.langSelect');
        const dropdown = document.getElementById('langDropdown');

        if (langSelect && dropdown && !langSelect.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });
}

// Calculate analytics
function calculateAnalytics() {
    const completedOrders = orders.filter(order => order.status === 'completed' || order.status === 'delivered');
    const totalSpent = completedOrders.reduce((sum, order) => sum + order.total, 0);
    const averageOrder = completedOrders.length > 0 ? totalSpent / completedOrders.length : 0;

    // Calculate favorite items based on purchase frequency
    const productCounts = {};
    completedOrders.forEach(order => {
        order.items.forEach(item => {
            const key = item.name[currentLang];
            productCounts[key] = (productCounts[key] || 0) + item.quantity;
        });
    });

    const topProduct = Object.entries(productCounts)
        .sort(([,a], [,b]) => b - a)[0];

    return {
        totalOrders: orders.length,
        completedOrders: completedOrders.length,
        totalSpent,
        averageOrder,
        favoriteItem: topProduct ? topProduct[0] : 'N/A'
    };
}

// Update summary cards
function updateSummaryCards() {
    const analytics = calculateAnalytics();
    const t = translations[currentLang];

    const elements = {
        'totalOrders': analytics.totalOrders,
        'totalSpent': `${analytics.totalSpent} DH`,
        'favoriteItem': analytics.favoriteItem,
        'averageOrder': `${Math.round(analytics.averageOrder)} DH`
    };

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
}

// Filter orders based on current filters
function getFilteredOrders() {
    let filtered = orders.filter(order => {
        // Search filter
        if (searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            const matchesId = order.id.toString().includes(searchLower);
            const matchesItems = order.items.some(item => 
                item.name[currentLang].toLowerCase().includes(searchLower)
            );
            if (!matchesId && !matchesItems) return false;
        }

        // Date filter
        if (dateFilter !== 'all') {
            const orderDate = new Date(order.date);
            const now = new Date();
            
            switch (dateFilter) {
                case 'today':
                    if (orderDate.toDateString() !== now.toDateString()) return false;
                    break;
                case 'thisWeek':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (orderDate < weekAgo) return false;
                    break;
                case 'thisMonth':
                    if (orderDate.getMonth() !== now.getMonth() || orderDate.getFullYear() !== now.getFullYear()) return false;
                    break;
                case 'thisYear':
                    if (orderDate.getFullYear() !== now.getFullYear()) return false;
                    break;
                case 'last30Days':
                    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (orderDate < thirtyDaysAgo) return false;
                    break;
                case 'last90Days':
                    const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    if (orderDate < ninetyDaysAgo) return false;
                    break;
            }
        }

        // Status filter
        if (statusFilter !== 'all' && order.status !== statusFilter) return false;

        return true;
    });

    // Sort orders
    switch (sortBy) {
        case 'oldest':
            filtered.sort((a, b) => a.date - b.date);
            break;
        case 'highest':
            filtered.sort((a, b) => b.total - a.total);
            break;
        case 'lowest':
            filtered.sort((a, b) => a.total - b.total);
            break;
        default: // newest
            filtered.sort((a, b) => b.date - a.date);
    }

    return filtered;
}

// Render orders
function renderOrders() {
    const filteredOrders = getFilteredOrders();
    const startIndex = (currentPage - 1) * ordersPerPage;
    const endIndex = startIndex + ordersPerPage;
    const paginatedOrders = filteredOrders.slice(startIndex, endIndex);
    
    const ordersList = document.getElementById('ordersList');
    const noOrders = document.getElementById('noOrders');
    const showingResults = document.getElementById('showingResults');
    
    if (!ordersList) return;

    const t = translations[currentLang];

    if (paginatedOrders.length === 0) {
        ordersList.style.display = 'none';
        if (noOrders) noOrders.style.display = 'block';
    } else {
        ordersList.style.display = 'grid';
        if (noOrders) noOrders.style.display = 'none';
        
        ordersList.innerHTML = '';
        paginatedOrders.forEach(order => {
            const orderCard = createOrderCard(order);
            ordersList.appendChild(orderCard);
        });
    }

    // Update showing results
    if (showingResults) {
        showingResults.textContent = t.showingResults.replace('{count}', filteredOrders.length);
    }
}

// Create order card
function createOrderCard(order) {
    const t = translations[currentLang];
    const formattedDate = order.date.toLocaleDateString(currentLang === 'ar' ? 'ar-MA' : currentLang);
    
    const card = document.createElement('div');
    card.className = 'orderCard';
    card.onclick = () => openTransactionModal(order);

    const statusClass = `status-${order.status}`;
    const statusText = t[order.status] || order.status;

    let itemsHtml = '';
    order.items.slice(0, 2).forEach(item => {
        itemsHtml += `
            <div class="orderItem">
                <img src="${item.image}" alt="${item.name[currentLang]}" class="itemImage" 
                     onerror="this.src='https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=100'">
                <div class="itemInfo">
                    <div class="itemName">${item.name[currentLang]}</div>
                    <div class="itemDetails">${t.quantity} ${item.quantity} √ó ${item.price} DH</div>
                </div>
                <button class="favoriteBtn ${favoriteProducts.has(item.id) ? 'active' : ''}" 
                        onclick="event.stopPropagation(); toggleFavorite(${item.id})">
                    ‚ù§Ô∏è
                </button>
            </div>
        `;
    });

    if (order.items.length > 2) {
        itemsHtml += `<p class="itemCount">+${order.items.length - 2} ${t.itemsCount}</p>`;
    }

    card.innerHTML = `
        <div class="content">
            <div class="orderHeader">
                <div>
                    <div class="orderNumber">${t.orderNumber}${order.id}</div>
                    <div class="orderDate">${formattedDate}</div>
                </div>
                <div class="statusBadge ${statusClass}">${statusText}</div>
            </div>
            <div class="orderItems">
                ${itemsHtml}
            </div>
            <div class="orderFooter">
                <div class="orderTotal">${order.total} DH</div>
                <div class="itemCount">${order.items.reduce((sum, item) => sum + item.quantity, 0)} ${t.itemsCount}</div>
            </div>
            <button class="viewDetailsBtn">
                üëÅÔ∏è ${t.viewDetails}
            </button>
        </div>
    `;

    return card;
}

// Toggle favorite
function toggleFavorite(productId) {
    if (favoriteProducts.has(productId)) {
        favoriteProducts.delete(productId);
    } else {
        favoriteProducts.add(productId);
    }
    
    localStorage.setItem('favoriteProducts', JSON.stringify([...favoriteProducts]));
    renderOrders(); // Re-render to update heart icons
}

// Open transaction modal
function openTransactionModal(order) {
    selectedOrder = order;
    const t = translations[currentLang];
    const modal = document.getElementById('transactionModal');
    const modalBody = document.getElementById('modalBody');
    
    if (!modal || !modalBody) return;

    const formattedDate = order.date.toLocaleDateString(currentLang === 'ar' ? 'ar-MA' : currentLang);
    const formattedTime = order.date.toLocaleTimeString(currentLang === 'ar' ? 'ar-MA' : currentLang, { 
        hour: '2-digit', 
        minute: '2-digit' 
    });

    let itemsHtml = '';
    order.items.forEach(item => {
        const subtotal = item.quantity * item.price;
        itemsHtml += `
            <div class="orderItem" style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; gap: 20px;">
                <img src="${item.image}" alt="${item.name[currentLang]}" class="itemImage" 
                     style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover;"
                     onerror="this.src='https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=100'">
                <div class="itemInfo" style="flex: 1;">
                    <div class="itemName" style="font-weight: 600; margin-bottom: 5px;">${item.name[currentLang]}</div>
                    <div class="itemDetails" style="color: #666; font-size: 14px;">
                        ${t.quantity} ${item.quantity}<br>
                        ${t.price} ${item.price} DH<br>
                        ${t.subtotal} ${subtotal} DH
                    </div>
                </div>
                <button class="favoriteBtn ${favoriteProducts.has(item.id) ? 'active' : ''}" 
                        onclick="toggleFavorite(${item.id})" 
                        style="padding: 8px; border: none; background: none; cursor: pointer; color: ${favoriteProducts.has(item.id) ? '#ef4444' : '#9ca3af'}; border-radius: 50%;">
                    ‚ù§Ô∏è
                </button>
            </div>
        `;
    });

    const statusClass = `status-${order.status}`;
    const statusText = t[order.status] || order.status;

    modalBody.innerHTML = `
        <div style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #667eea; font-size: 1.5em; margin-bottom: 5px;">${t.orderNumber}${order.id}</h3>
                    <p style="color: #666; margin-bottom: 5px;">${formattedDate} ${formattedTime}</p>
                    ${order.trackingNumber ? `<p style="color: #667eea; font-size: 14px;">Tracking: ${order.trackingNumber}</p>` : ''}
                </div>
                <span class="statusBadge ${statusClass}">${statusText}</span>
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="font-size: 1.2em; margin-bottom: 20px; color: #333;">Articles command√©s</h4>
            <div style="border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden;">
                ${itemsHtml}
            </div>
        </div>
        
        <div style="border-top: 2px solid rgba(0,0,0,0.1); padding-top: 20px; text-align: right;">
            <div style="font-size: 1.5em; font-weight: 700; color: #28a745;">
                ${t.orderTotal} ${order.total} DH
            </div>
        </div>
    `;

    modal.classList.add('active');
}

// Close transaction modal
function closeTransactionModal() {
    const modal = document.getElementById('transactionModal');
    if (modal) modal.classList.remove('active');
    selectedOrder = null;
}

// Update pagination
function updatePagination() {
    const filteredOrders = getFilteredOrders();
    const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
    const pagination = document.getElementById('pagination');
    
    if (!pagination) return;

    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }

    pagination.style.display = 'flex';
    pagination.innerHTML = '';

    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pageBtn';
    prevBtn.textContent = '‚Äπ';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderOrders();
            updatePagination();
        }
    };
    pagination.appendChild(prevBtn);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `pageBtn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
            currentPage = i;
            renderOrders();
            updatePagination();
        };
        pagination.appendChild(pageBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pageBtn';
    nextBtn.textContent = '‚Ä∫';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderOrders();
            updatePagination();
        }
    };
    pagination.appendChild(nextBtn);
}

// Clear filters
function clearFilters() {
    searchTerm = '';
    dateFilter = 'all';
    statusFilter = 'all';
    sortBy = 'newest';
    currentPage = 1;

    const searchInput = document.getElementById('searchInput');
    const dateFilterSelect = document.getElementById('dateFilter');
    const statusFilterSelect = document.getElementById('statusFilter');
    const sortBySelect = document.getElementById('sortBy');

    if (searchInput) searchInput.value = '';
    if (dateFilterSelect) dateFilterSelect.value = 'all';
    if (statusFilterSelect) statusFilterSelect.value = 'all';
    if (sortBySelect) sortBySelect.value = 'newest';

    renderOrders();
    updatePagination();
}

// Export orders
function exportOrders() {
    const filteredOrders = getFilteredOrders();
    const t = translations[currentLang];
    
    const csvContent = [
        `${t.orderNumber},${t.orderDate},${t.orderStatus},${t.orderTotal},Items`,
        ...filteredOrders.map(order => 
            `${order.id},${order.date.toISOString().split('T')[0]},${t[order.status] || order.status},${order.total} DH,"${order.items.map(item => `${item.name[currentLang]} (${item.quantity})`).join('; ')}"`
        )
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'order-history.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Refresh orders
function refreshOrders() {
    // Simulate refreshing data
    orders = [...sampleOrders];
    updateSummaryCards();
    renderOrders();
    updatePagination();
    showNotification('Donn√©es actualis√©es!', 'success');
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: ${type === 'success' ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #667eea, #764ba2)'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 5000;
        font-weight: 600;
        animation: slideIn 0.4s ease;
        backdrop-filter: blur(20px);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Language functions
function toggleLangDropdown() {
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) dropdown.classList.toggle('show');
}

function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('selectedLanguage', lang);
    updateLanguage();
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) dropdown.classList.remove('show');
}

function updateLanguage() {
    const t = translations[currentLang];

    // Update navigation
    const navElements = {
        'btn-menu': t.menu,
        'btn-produit': t.produit,
        'btn-games': t.games,
        'btn-history': t.history,
        'btn-contact': t.contact,
        'pageTitle': t.pageTitle,
        'profileTitle': t.profile,
        'logoutBtn': t.logout,
        'totalOrdersLabel': t.totalOrdersLabel,
        'totalSpentLabel': t.totalSpentLabel,
        'favoriteItemLabel': t.favoriteItemLabel,
        'averageOrderLabel': t.averageOrderLabel,
        'dateFilterLabel': t.dateFilterLabel,
        'statusFilterLabel': t.statusFilterLabel,
        'sortByLabel': t.sortByLabel,
        'clearFiltersBtn': t.clearFiltersBtn,
        'exportBtn': t.exportBtn,
        'refreshBtn': t.refreshBtn,
        'ordersSectionTitle': t.ordersSectionTitle,
        'noOrdersTitle': t.noOrdersTitle,
        'noOrdersText': t.noOrdersText,
        'orderNowBtn': t.orderNowBtn,
        'modalTitle': t.modalTitle
    };

    Object.entries(navElements).forEach(([id, text]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = text;
    });

    // Update profile info
    const profileInfo = document.getElementById('profileInfo');
    if (profileInfo) {
        profileInfo.innerHTML = `
            <p>${t.profileName}</p>
            <p>${t.profileEmail}</p>
            <p>${t.profileMember}</p>
        `;
    }

    // Update order history
    const orderHistory = document.getElementById('orderHistory');
    if (orderHistory) {
        orderHistory.innerHTML = `
            <h3>${t.orderHistoryTitle}</h3>
            <p>${t.orderHistoryEmpty}</p>
        `;
    }

    // Update filter options
    updateFilterOptions();

    // Update summary cards and orders
    updateSummaryCards();
    renderOrders();

    // Handle RTL for Arabic
    if (currentLang === 'ar') {
        document.body.setAttribute('dir', 'rtl');
        document.body.style.fontFamily = 'Arial, Tahoma, sans-serif';
    } else {
        document.body.setAttribute('dir', 'ltr');
        document.body.style.fontFamily = 'Inter, Segoe UI, sans-serif';
    }
}

// Update filter options
function updateFilterOptions() {
    const t = translations[currentLang];
    
    // Update date filter options
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter) {
        dateFilter.innerHTML = `
            <option value="all">${t.allPeriods}</option>
            <option value="today">${t.today}</option>
            <option value="thisWeek">${t.thisWeek}</option>
            <option value="thisMonth">${t.thisMonth}</option>
            <option value="last30Days">${t.last30Days}</option>
            <option value="last90Days">${t.last90Days}</option>
            <option value="thisYear">${t.thisYear}</option>
        `;
    }

    // Update status filter options
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.innerHTML = `
            <option value="all">${t.allStatuses}</option>
            <option value="completed">${t.completed}</option>
            <option value="pending">${t.pending}</option>
            <option value="processing">${t.processing}</option>
            <option value="shipped">${t.shipped}</option>
            <option value="delivered">${t.delivered}</option>
            <option value="cancelled">${t.cancelled}</option>
        `;
    }

    // Update sort options
    const sortBy = document.getElementById('sortBy');
    if (sortBy) {
        sortBy.innerHTML = `
            <option value="newest">${t.sortNewest}</option>
            <option value="oldest">${t.sortOldest}</option>
            <option value="highest">${t.sortHighest}</option>
            <option value="lowest">${t.sortLowest}</option>
        `;
    }

    // Update search placeholder
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.placeholder = t.searchPlaceholder;
    }
}

// Dark mode toggle
function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');

    const toggle = document.getElementById('darkModeToggle');
    if (toggle) {
        toggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
    }

    localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
}

// Account functions
function showAccount() {
    const slide = document.getElementById('accountSlide');
    if (slide) slide.classList.add('show');
}

function closeAccount() {
    const slide = document.getElementById('accountSlide');
    if (slide) slide.classList.remove('show');
}

// Logout function
function logout() {
    const t = translations[currentLang];
    const logoutBtn = document.getElementById('logoutBtn');
    if (!logoutBtn) return;
    
    if (!confirm(t.logoutConfirm)) return;
    
    const originalText = logoutBtn.textContent;
    logoutBtn.textContent = t.logoutInProgress;
    logoutBtn.disabled = true;
    logoutBtn.style.opacity = '0.7';
    
    localStorage.removeItem('indumilk_currentUser');
    localStorage.removeItem('indumilk_session');
    localStorage.removeItem('indumilk_token');
    localStorage.removeItem('userPreferences');
    
    setTimeout(() => {
        logoutBtn.textContent = t.logoutSuccess;
        logoutBtn.style.backgroundColor = '#4CAF50';
        closeAccount();
        setTimeout(() => { 
            window.location.href = 'index.html'; 
        }, 800);
    }, 1000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', init);