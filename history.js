// Translations for History Page
const translations = {
    fr: {
        menu: "Menu",
        produit: "Produit",
        games: "Mini Jeux",
        history: "Histoire",
        contact: "Contact",
        profile: "Profil",
        logout: "DÃ©connexion",
        pageTitle: "Historique des Commandes",
        profileName: "Nom: Utilisateur InvitÃ©",
        profileEmail: "Email: guest@indumilk.com",
        profileMember: "Membre depuis: 2024",
        orderHistoryTitle: "Historique des commandes",
        orderHistoryEmpty: "Aucune commande rÃ©cente",
        logoutSuccess: "DÃ©connexion rÃ©ussie!",
        logoutConfirm: "ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter?",
        logoutInProgress: "DÃ©connexion en cours...",
        totalOrdersLabel: "Total des Commandes",
        totalSpentLabel: "Total DÃ©pensÃ©",
        favoriteItemLabel: "Article PrÃ©fÃ©rÃ©",
        averageOrderLabel: "Commande Moyenne",
        searchPlaceholder: "Rechercher des commandes...",
        dateFilterLabel: "Filtrer par pÃ©riode:",
        statusFilterLabel: "Filtrer par statut:",
        sortByLabel: "Trier par:",
        clearFiltersBtn: "Effacer les filtres",
        exportBtn: "Exporter",
        refreshBtn: "Actualiser",
        ordersSectionTitle: "Vos Commandes",
        noOrdersTitle: "Aucune commande trouvÃ©e",
        noOrdersText: "Vous n'avez pas encore passÃ© de commandes ou aucune commande ne correspond aux filtres sÃ©lectionnÃ©s.",
        orderNowBtn: "Commander maintenant",
        modalTitle: "DÃ©tails de la Commande",
        orderNumber: "Commande #",
        orderDate: "Date:",
        orderStatus: "Statut:",
        orderTotal: "Total:",
        completed: "TerminÃ©",
        pending: "En attente",
        cancelled: "AnnulÃ©",
        processing: "En cours",
        shipped: "ExpÃ©diÃ©",
        delivered: "LivrÃ©",
        allPeriods: "Toutes les pÃ©riodes",
        today: "Aujourd'hui",
        thisWeek: "Cette semaine",
        thisMonth: "Ce mois",
        thisYear: "Cette annÃ©e",
        last30Days: "30 derniers jours",
        last90Days: "90 derniers jours",
        allStatuses: "Tous les statuts",
        quantity: "QuantitÃ©:",
        price: "Prix:",
        subtotal: "Sous-total:",
        viewDetails: "Voir les dÃ©tails",
        addToFavorites: "Ajouter aux favoris",
        removeFromFavorites: "Retirer des favoris",
        sortNewest: "Plus rÃ©cent",
        sortOldest: "Plus ancien",
        sortHighest: "Montant le plus Ã©levÃ©",
        sortLowest: "Montant le plus bas",
        itemsCount: "articles",
        showingResults: "Affichage de {count} rÃ©sultats"
    },
    en: {
        menu: "Menu",
        produit: "Products",
        games: "Mini Games",
        history: "History",
        contact: "Contact",
        profile: "Profile",
        logout: "Logout",
        pageTitle: "Order History",
        profileName: "Name: Guest User",
        profileEmail: "Email: guest@indumilk.com",
        profileMember: "Member since: 2024",
        orderHistoryTitle: "Order History",
        orderHistoryEmpty: "No recent orders",
        logoutSuccess: "Logout successful!",
        logoutConfirm: "Are you sure you want to logout?",
        logoutInProgress: "Logging out...",
        totalOrdersLabel: "Total Orders",
        totalSpentLabel: "Total Spent",
        favoriteItemLabel: "Favorite Item",
        averageOrderLabel: "Average Order",
        searchPlaceholder: "Search orders...",
        dateFilterLabel: "Filter by period:",
        statusFilterLabel: "Filter by status:",
        sortByLabel: "Sort by:",
        clearFiltersBtn: "Clear filters",
        exportBtn: "Export",
        refreshBtn: "Refresh",
        ordersSectionTitle: "Your Orders",
        noOrdersTitle: "No orders found",
        noOrdersText: "You haven't placed any orders yet or no orders match the selected filters.",
        orderNowBtn: "Order now",
        modalTitle: "Order Details",
        orderNumber: "Order #",
        orderDate: "Date:",
        orderStatus: "Status:",
        orderTotal: "Total:",
        completed: "Completed",
        pending: "Pending",
        cancelled: "Cancelled",
        processing: "Processing",
        shipped: "Shipped",
        delivered: "Delivered",
        allPeriods: "All periods",
        today: "Today",
        thisWeek: "This week",
        thisMonth: "This month",
        thisYear: "This year",
        last30Days: "Last 30 days",
        last90Days: "Last 90 days",
        allStatuses: "All statuses",
        quantity: "Quantity:",
        price: "Price:",
        subtotal: "Subtotal:",
        viewDetails: "View Details",
        addToFavorites: "Add to Favorites",
        removeFromFavorites: "Remove from Favorites",
        sortNewest: "Newest first",
        sortOldest: "Oldest first",
        sortHighest: "Highest amount",
        sortLowest: "Lowest amount",
        itemsCount: "items",
        showingResults: "Showing {count} results"
    },
    ar: {
        menu: "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
        produit: "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
        games: "Ø£Ù„Ø¹Ø§Ø¨ Ù…ØµØºØ±Ø©",
        history: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
        contact: "Ø§ØªØµÙ„",
        profile: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
        logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
        pageTitle: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
        profileName: "Ø§Ù„Ø§Ø³Ù…: Ù…Ø³ØªØ®Ø¯Ù… Ø¶ÙŠÙ",
        profileEmail: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: guest@indumilk.com",
        profileMember: "Ø¹Ø¶Ùˆ Ù…Ù†Ø°: 2024",
        orderHistoryTitle: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
        orderHistoryEmpty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø¯ÙŠØ«Ø©",
        logoutSuccess: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!",
        logoutConfirm: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ",
        logoutInProgress: "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...",
        totalOrdersLabel: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
        totalSpentLabel: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù†ÙÙ‚",
        favoriteItemLabel: "Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…ÙØ¶Ù„",
        averageOrderLabel: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·Ù„Ø¨",
        searchPlaceholder: "Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...",
        dateFilterLabel: "ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©:",
        statusFilterLabel: "ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©:",
        sortByLabel: "ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:",
        clearFiltersBtn: "Ù…Ø³Ø­ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª",
        exportBtn: "ØªØµØ¯ÙŠØ±",
        refreshBtn: "ØªØ­Ø¯ÙŠØ«",
        ordersSectionTitle: "Ø·Ù„Ø¨Ø§ØªÙƒ",
        noOrdersTitle: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª",
        noOrdersText: "Ù„Ù… ØªÙ‚Ù… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.",
        orderNowBtn: "Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†",
        modalTitle: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨",
        orderNumber: "Ø·Ù„Ø¨ #",
        orderDate: "Ø§Ù„ØªØ§Ø±ÙŠØ®:",
        orderStatus: "Ø§Ù„Ø­Ø§Ù„Ø©:",
        orderTotal: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:",
        completed: "Ù…ÙƒØªÙ…Ù„",
        pending: "ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
        cancelled: "Ù…Ù„ØºÙŠ",
        processing: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
        shipped: "ØªÙ… Ø§Ù„Ø´Ø­Ù†",
        delivered: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
        allPeriods: "Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª",
        today: "Ø§Ù„ÙŠÙˆÙ…",
        thisWeek: "Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
        thisMonth: "Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±",
        thisYear: "Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…",
        last30Days: "Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ø§Ù‹",
        last90Days: "Ø¢Ø®Ø± 90 ÙŠÙˆÙ…Ø§Ù‹",
        allStatuses: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª",
        quantity: "Ø§Ù„ÙƒÙ…ÙŠØ©:",
        price: "Ø§Ù„Ø³Ø¹Ø±:",
        subtotal: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:",
        viewDetails: "Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„",
        addToFavorites: "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©",
        removeFromFavorites: "Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©",
        sortNewest: "Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹",
        sortOldest: "Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹",
        sortHighest: "Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„Øº",
        sortLowest: "Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº",
        itemsCount: "Ø¹Ù†Ø§ØµØ±",
        showingResults: "Ø¹Ø±Ø¶ {count} Ù†ØªØ§Ø¦Ø¬"
    }
};

// Sample order data
const sampleOrders = [
    {
        id: 2001,
        date: new Date('2024-01-15'),
        status: 'completed',
        items: [
            { id: 1, name: { fr: "Lait Frais Premium", en: "Premium Fresh Milk", ar: "Ø­Ù„ÙŠØ¨ Ø·Ø§Ø²Ø¬ ÙØ§Ø®Ø±" }, quantity: 2, price: 15, image: "lait.jpg" },
            { id: 2, name: { fr: "Mozzarella Artisanale", en: "Artisan Mozzarella", ar: "Ù…ÙˆØªØ²Ø§Ø±ÙŠÙ„Ø§ Ø­Ø±ÙÙŠØ©" }, quantity: 1, price: 45, image: "mozarella.jpg" }
        ],
        total: 75,
        trackingNumber: "TRK001234567"
    },
    {
        id: 2002,
        date: new Date('2024-01-10'),
        status: 'shipped',
        items: [
            { id: 3, name: { fr: "CrÃ¨me FraÃ®che Premium", en: "Premium Fresh Cream", ar: "ÙƒØ±ÙŠÙ…Ø© Ø·Ø§Ø²Ø¬Ø© ÙØ§Ø®Ø±Ø©" }, quantity: 1, price: 25, image: "creme.jpg" },
            { id: 6, name: { fr: "Yaourt Nature Bio", en: "Organic Natural Yogurt", ar: "Ø²Ø¨Ø§Ø¯ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ Ø¹Ø¶ÙˆÙŠ" }, quantity: 3, price: 12, image: "yogurt.jpg" }
        ],
        total: 61,
        trackingNumber: "TRK001234568"
    },
    {
        id: 2003,
        date: new Date('2024-01-05'),
        status: 'delivered',
        items: [
            { id: 4, name: { fr: "Ricotta DÃ©licate", en: "Delicate Ricotta", ar: "Ø±ÙŠÙƒÙˆØªØ§ Ø±Ù‚ÙŠÙ‚Ø©" }, quantity: 1, price: 35, image: "ricotta.png" },
            { id: 5, name: { fr: "Fromage Edam", en: "Edam Cheese", ar: "Ø¬Ø¨Ù† Ø¥ÙŠØ¯Ø§Ù…" }, quantity: 1, price: 55, image: "fromage edam.jpg" }
        ],
        total: 90,
        trackingNumber: "TRK001234569"
    },
    {
        id: 2004,
        date: new Date('2023-12-28'),
        status: 'pending',
        items: [
            { id: 1, name: { fr: "Lait Frais Premium", en: "Premium Fresh Milk", ar: "Ø­Ù„ÙŠØ¨ Ø·Ø§Ø²Ø¬ ÙØ§Ø®Ø±" }, quantity: 1, price: 15, image: "lait.jpg" }
        ],
        total: 15,
        trackingNumber: "TRK001234570"
    },
    {
        id: 2005,
        date: new Date('2023-12-20'),
        status: 'cancelled',
        items: [
            { id: 2, name: { fr: "Mozzarella Artisanale", en: "Artisan Mozzarella", ar: "Ù…ÙˆØªØ²Ø§Ø±ÙŠÙ„Ø§ Ø­Ø±ÙÙŠØ©" }, quantity: 2, price: 45, image: "mozarella.jpg" }
        ],
        total: 90,
        trackingNumber: "TRK001234571"
    }
];

// State variables
let currentLang = 'fr';
let isDarkMode = false;
let orders = [...sampleOrders];
let searchTerm = '';
let dateFilter = 'all';
let statusFilter = 'all';
let sortBy = 'newest';
let selectedOrder = null;
let favoriteProducts = new Set([1, 3, 5]);
let currentPage = 1;
const ordersPerPage = 6;

// Initialize the application
function init() {
    loadSettings();
    loadUserProfile();
    updateLanguage();
    setupEventListeners();
    updateSummaryCards();
    renderOrders();
    updatePagination();
}

// Load saved settings
function loadSettings() {
    const savedLang = localStorage.getItem('selectedLanguage');
    if (savedLang && translations[savedLang]) {
        currentLang = savedLang;
    }

    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === 'enabled') {
        isDarkMode = true;
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) toggle.textContent = 'â˜€ï¸';
    }

    const savedFavorites = localStorage.getItem('favoriteProducts');
    if (savedFavorites) {
        try {
            favoriteProducts = new Set(JSON.parse(savedFavorites));
        } catch (e) {
            favoriteProducts = new Set([1, 3, 5]);
        }
    }
}

// Load user profile information
function loadUserProfile() {
    try {
        const currentUser = JSON.parse(localStorage.getItem('indumilk_currentUser'));
        if (currentUser) {
            updateProfileDisplay(currentUser);
        }
    } catch (e) {
        console.log('No user data found, using guest profile');
    }
}

// Update profile display with actual user data
function updateProfileDisplay(user) {
    const t = translations[currentLang];
    const profileInfo = document.getElementById('profileInfo');
    if (profileInfo && user) {
        const memberSince = user.createdAt ? new Date(user.createdAt).getFullYear() : '2024';
        profileInfo.innerHTML = `
            <p>${t.profileName.replace('Utilisateur InvitÃ©', user.name || 'Utilisateur InvitÃ©').replace('Guest User', user.name || 'Guest User').replace('Ù…Ø³ØªØ®Ø¯Ù… Ø¶ÙŠÙ', user.name || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¶ÙŠÙ')}</p>
            <p>${t.profileEmail.replace('guest@indumilk.com', user.email || 'guest@indumilk.com')}</p>
            <p>${t.profileMember.replace('2024', memberSince)}</p>
        `;
    }
}

// Setup event listeners
function setupEventListeners() {
    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            currentPage = 1;
            renderOrders();
            updatePagination();
        });
    }

    // Filter selects
    const dateFilterSelect = document.getElementById('dateFilter');
    if (dateFilterSelect) {
        dateFilterSelect.addEventListener('change', (e) => {
            dateFilter = e.target.value;
            currentPage = 1;
            renderOrders();
            updatePagination();
        });
    }

    const statusFilterSelect = document.getElementById('statusFilter');
    if (statusFilterSelect) {
        statusFilterSelect.addEventListener('change', (e) => {
            statusFilter = e.target.value;
            currentPage = 1;
            renderOrders();
            updatePagination();
        });
    }

    const sortBySelect = document.getElementById('sortBy');
    if (sortBySelect) {
        sortBySelect.addEventListener('change', (e) => {
            sortBy = e.target.value;
            renderOrders();
            updatePagination();
        });
    }

    // Close modal when clicking outside
    const modal = document.getElementById('transactionModal');
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeTransactionModal();
            }
        });
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        const langSelect = document.querySelector('.langSelect');
        const dropdown = document.getElementById('langDropdown');

        if (langSelect && dropdown && !langSelect.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });
}

// Calculate analytics
function calculateAnalytics() {
    const completedOrders = orders.filter(order => order.status === 'completed' || order.status === 'delivered');
    const totalSpent = completedOrders.reduce((sum, order) => sum + order.total, 0);
    const averageOrder = completedOrders.length > 0 ? totalSpent / completedOrders.length : 0;

    // Calculate favorite items based on purchase frequency
    const productCounts = {};
    completedOrders.forEach(order => {
        order.items.forEach(item => {
            const key = item.name[currentLang];
            productCounts[key] = (productCounts[key] || 0) + item.quantity;
        });
    });

    const topProduct = Object.entries(productCounts)
        .sort(([,a], [,b]) => b - a)[0];

    return {
        totalOrders: orders.length,
        completedOrders: completedOrders.length,
        totalSpent,
        averageOrder,
        favoriteItem: topProduct ? topProduct[0] : 'N/A'
    };
}

// Update summary cards
function updateSummaryCards() {
    const analytics = calculateAnalytics();
    const t = translations[currentLang];

    const elements = {
        'totalOrders': analytics.totalOrders,
        'totalSpent': `${analytics.totalSpent} DH`,
        'favoriteItem': analytics.favoriteItem,
        'averageOrder': `${Math.round(analytics.averageOrder)} DH`
    };

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
}

// Filter orders based on current filters
function getFilteredOrders() {
    let filtered = orders.filter(order => {
        // Search filter
        if (searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            const matchesId = order.id.toString().includes(searchLower);
            const matchesItems = order.items.some(item => 
                item.name[currentLang].toLowerCase().includes(searchLower)
            );
            if (!matchesId && !matchesItems) return false;
        }

        // Date filter
        if (dateFilter !== 'all') {
            const orderDate = new Date(order.date);
            const now = new Date();
            
            switch (dateFilter) {
                case 'today':
                    if (orderDate.toDateString() !== now.toDateString()) return false;
                    break;
                case 'thisWeek':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (orderDate < weekAgo) return false;
                    break;
                case 'thisMonth':
                    if (orderDate.getMonth() !== now.getMonth() || orderDate.getFullYear() !== now.getFullYear()) return false;
                    break;
                case 'thisYear':
                    if (orderDate.getFullYear() !== now.getFullYear()) return false;
                    break;
                case 'last30Days':
                    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (orderDate < thirtyDaysAgo) return false;
                    break;
                case 'last90Days':
                    const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    if (orderDate < ninetyDaysAgo) return false;
                    break;
            }
        }

        // Status filter
        if (statusFilter !== 'all' && order.status !== statusFilter) return false;

        return true;
    });

    // Sort orders
    switch (sortBy) {
        case 'oldest':
            filtered.sort((a, b) => a.date - b.date);
            break;
        case 'highest':
            filtered.sort((a, b) => b.total - a.total);
            break;
        case 'lowest':
            filtered.sort((a, b) => a.total - b.total);
            break;
        default: // newest
            filtered.sort((a, b) => b.date - a.date);
    }

    return filtered;
}

// Render orders
function renderOrders() {
    const filteredOrders = getFilteredOrders();
    const startIndex = (currentPage - 1) * ordersPerPage;
    const endIndex = startIndex + ordersPerPage;
    const paginatedOrders = filteredOrders.slice(startIndex, endIndex);
    
    const ordersList = document.getElementById('ordersList');
    const noOrders = document.getElementById('noOrders');
    const showingResults = document.getElementById('showingResults');
    
    if (!ordersList) return;

    const t = translations[currentLang];

    if (paginatedOrders.length === 0) {
        ordersList.style.display = 'none';
        if (noOrders) noOrders.style.display = 'block';
    } else {
        ordersList.style.display = 'grid';
        if (noOrders) noOrders.style.display = 'none';
        
        ordersList.innerHTML = '';
        paginatedOrders.forEach(order => {
            const orderCard = createOrderCard(order);
            ordersList.appendChild(orderCard);
        });
    }

    // Update showing results
    if (showingResults) {
        showingResults.textContent = t.showingResults.replace('{count}', filteredOrders.length);
    }
}

// Create order card
function createOrderCard(order) {
    const t = translations[currentLang];
    const formattedDate = order.date.toLocaleDateString(currentLang === 'ar' ? 'ar-MA' : currentLang);
    
    const card = document.createElement('div');
    card.className = 'orderCard';
    card.onclick = () => openTransactionModal(order);

    const statusClass = `status-${order.status}`;
    const statusText = t[order.status] || order.status;

    let itemsHtml = '';
    order.items.slice(0, 2).forEach(item => {
        itemsHtml += `
            <div class="orderItem">
                <img src="${item.image}" alt="${item.name[currentLang]}" class="itemImage" 
                     onerror="this.src='https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=100'">
                <div class="itemInfo">
                    <div class="itemName">${item.name[currentLang]}</div>
                    <div class="itemDetails">${t.quantity} ${item.quantity} Ã— ${item.price} DH</div>
                </div>
                <button class="favoriteBtn ${favoriteProducts.has(item.id) ? 'active' : ''}" 
                        onclick="event.stopPropagation(); toggleFavorite(${item.id})">
                    â¤ï¸
                </button>
            </div>
        `;
    });

    if (order.items.length > 2) {
        itemsHtml += `<p class="itemCount">+${order.items.length - 2} ${t.itemsCount}</p>`;
    }

    card.innerHTML = `
        <div class="content">
            <div class="orderHeader">
                <div>
                    <div class="orderNumber">${t.orderNumber}${order.id}</div>
                    <div class="orderDate">${formattedDate}</div>
                </div>
                <div class="statusBadge ${statusClass}">${statusText}</div>
            </div>
            <div class="orderItems">
                ${itemsHtml}
            </div>
            <div class="orderFooter">
                <div class="orderTotal">${order.total} DH</div>
                <div class="itemCount">${order.items.reduce((sum, item) => sum + item.quantity, 0)} ${t.itemsCount}</div>
            </div>
            <button class="viewDetailsBtn">
                ğŸ‘ï¸ ${t.viewDetails}
            </button>
        </div>
    `;

    return card;
}

// Toggle favorite
function toggleFavorite(productId) {
    if (favoriteProducts.has(productId)) {
        favoriteProducts.delete(productId);
    } else {
        favoriteProducts.add(productId);
    }
    
    localStorage.setItem('favoriteProducts', JSON.stringify([...favoriteProducts]));
    renderOrders(); // Re-render to update heart icons
}

// Open transaction modal
function openTransactionModal(order) {
    selectedOrder = order;
    const t = translations[currentLang];
    const modal = document.getElementById('transactionModal');
    const modalBody = document.getElementById('modalBody');
    
    if (!modal || !modalBody) return;

    const formattedDate = order.date.toLocaleDateString(currentLang === 'ar' ? 'ar-MA' : currentLang);
    const formattedTime = order.date.toLocaleTimeString(currentLang === 'ar' ? 'ar-MA' : currentLang, { 
        hour: '2-digit', 
        minute: '2-digit' 
    });

    let itemsHtml = '';
    order.items.forEach(item => {
        const subtotal = item.quantity * item.price;
        itemsHtml += `
            <div class="orderItem" style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; gap: 20px;">
                <img src="${item.image}" alt="${item.name[currentLang]}" class="itemImage" 
                     style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover;"
                     onerror="this.src='https://images.pexels.com/photos/416978/pexels-photo-416978.jpeg?auto=compress&cs=tinysrgb&w=100'">
                <div class="itemInfo" style="flex: 1;">
                    <div class="itemName" style="font-weight: 600; margin-bottom: 5px;">${item.name[currentLang]}</div>
                    <div class="itemDetails" style="color: #666; font-size: 14px;">
                        ${t.quantity} ${item.quantity}<br>
                        ${t.price} ${item.price} DH<br>
                        ${t.subtotal} ${subtotal} DH
                    </div>
                </div>
                <button class="favoriteBtn ${favoriteProducts.has(item.id) ? 'active' : ''}" 
                        onclick="toggleFavorite(${item.id})" 
                        style="padding: 8px; border: none; background: none; cursor: pointer; color: ${favoriteProducts.has(item.id) ? '#ef4444' : '#9ca3af'}; border-radius: 50%;">
                    â¤ï¸
                </button>
            </div>
        `;
    });

    const statusClass = `status-${order.status}`;
    const statusText = t[order.status] || order.status;

    modalBody.innerHTML = `
        <div style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #667eea; font-size: 1.5em; margin-bottom: 5px;">${t.orderNumber}${order.id}</h3>
                    <p style="color: #666; margin-bottom: 5px;">${formattedDate} ${formattedTime}</p>
                    ${order.trackingNumber ? `<p style="color: #667eea; font-size: 14px;">Tracking: ${order.trackingNumber}</p>` : ''}
                </div>
                <span class="statusBadge ${statusClass}">${statusText}</span>
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="font-size: 1.2em; margin-bottom: 20px; color: #333;">Articles commandÃ©s</h4>
            <div style="border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden;">
                ${itemsHtml}
            </div>
        </div>
        
        <div style="border-top: 2px solid rgba(0,0,0,0.1); padding-top: 20px; text-align: right;">
            <div style="font-size: 1.5em; font-weight: 700; color: #28a745;">
                ${t.orderTotal} ${order.total} DH
            </div>
        </div>
    `;

    modal.classList.add('active');
}

// Close transaction modal
function closeTransactionModal() {
    const modal = document.getElementById('transactionModal');
    if (modal) modal.classList.remove('active');
    selectedOrder = null;
}

// Update pagination
function updatePagination() {
    const filteredOrders = getFilteredOrders();
    const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
    const pagination = document.getElementById('pagination');
    
    if (!pagination) return;

    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }

    pagination.style.display = 'flex';
    pagination.innerHTML = '';

    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pageBtn';
    prevBtn.textContent = 'â€¹';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderOrders();
            updatePagination();
        }
    };
    pagination.appendChild(prevBtn);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `pageBtn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
            currentPage = i;
            renderOrders();
            updatePagination();
        };
        pagination.appendChild(pageBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pageBtn';
    nextBtn.textContent = 'â€º';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderOrders();
            updatePagination();
        }
    };
    pagination.appendChild(nextBtn);
}

// Clear filters
function clearFilters() {
    searchTerm = '';
    dateFilter = 'all';
    statusFilter = 'all';
    sortBy = 'newest';
    currentPage = 1;

    const searchInput = document.getElementById('searchInput');
    const dateFilterSelect = document.getElementById('dateFilter');
    const statusFilterSelect = document.getElementById('statusFilter');
    const sortBySelect = document.getElementById('sortBy');

    if (searchInput) searchInput.value = '';
    if (dateFilterSelect) dateFilterSelect.value = 'all';
    if (statusFilterSelect) statusFilterSelect.value = 'all';
    if (sortBySelect) sortBySelect.value = 'newest';

    renderOrders();
    updatePagination();
}

// Export orders
function exportOrders() {
    const filteredOrders = getFilteredOrders();
    const t = translations[currentLang];
    
    const csvContent = [
        `${t.orderNumber},${t.orderDate},${t.orderStatus},${t.orderTotal},Items`,
        ...filteredOrders.map(order => 
            `${order.id},${order.date.toISOString().split('T')[0]},${t[order.status] || order.status},${order.total} DH,"${order.items.map(item => `${item.name[currentLang]} (${item.quantity})`).join('; ')}"`
        )
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'order-history.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Refresh orders
function refreshOrders() {
    // Simulate refreshing data
    orders = [...sampleOrders];
    updateSummaryCards();
    renderOrders();
    updatePagination();
    showNotification('DonnÃ©es actualisÃ©es!', 'success');
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: ${type === 'success' ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #667eea, #764ba2)'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 5000;
        font-weight: 600;
        animation: slideIn 0.4s ease;
        backdrop-filter: blur(20px);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Language functions
function toggleLangDropdown() {
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) dropdown.classList.toggle('show');
}

function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('selectedLanguage', lang);
    updateLanguage();
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) dropdown.classList.remove('show');
}

function updateLanguage() {
    const t = translations[currentLang];

    // Update navigation
    const navElements = {
        'btn-menu': t.menu,
        'btn-produit': t.produit,
        'btn-games': t.games,
        'btn-history': t.history,
        'btn-contact': t.contact,
        'pageTitle': t.pageTitle,
        'profileTitle': t.profile,
        'logoutBtn': t.logout,
        'totalOrdersLabel': t.totalOrdersLabel,
        'totalSpentLabel': t.totalSpentLabel,
        'favoriteItemLabel': t.favoriteItemLabel,
        'averageOrderLabel': t.averageOrderLabel,
        'dateFilterLabel': t.dateFilterLabel,
        'statusFilterLabel': t.statusFilterLabel,
        'sortByLabel': t.sortByLabel,
        'clearFiltersBtn': t.clearFiltersBtn,
        'exportBtn': t.exportBtn,
        'refreshBtn': t.refreshBtn,
        'ordersSectionTitle': t.ordersSectionTitle,
        'noOrdersTitle': t.noOrdersTitle,
        'noOrdersText': t.noOrdersText,
        'orderNowBtn': t.orderNowBtn,
        'modalTitle': t.modalTitle
    };

    Object.entries(navElements).forEach(([id, text]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = text;
    });

    // Update profile info
    const profileInfo = document.getElementById('profileInfo');
    if (profileInfo) {
        // Re-load user profile with new language
        loadUserProfile();
    }

    // Update order history
    const orderHistory = document.getElementById('orderHistory');
    if (orderHistory) {
        orderHistory.innerHTML = `
            <h3>${t.orderHistoryTitle}</h3>
            <p>${t.orderHistoryEmpty}</p>
        `;
    }

    // Update filter options
    updateFilterOptions();

    // Update summary cards and orders
    updateSummaryCards();
    renderOrders();

    // Handle RTL for Arabic
    if (currentLang === 'ar') {
        document.body.setAttribute('dir', 'rtl');
        document.body.style.fontFamily = 'Arial, Tahoma, sans-serif';
    } else {
        document.body.setAttribute('dir', 'ltr');
        document.body.style.fontFamily = 'Inter, Segoe UI, sans-serif';
    }
}

// Update filter options
function updateFilterOptions() {
    const t = translations[currentLang];
    
    // Update date filter options
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter) {
        dateFilter.innerHTML = `
            <option value="all">${t.allPeriods}</option>
            <option value="today">${t.today}</option>
            <option value="thisWeek">${t.thisWeek}</option>
            <option value="thisMonth">${t.thisMonth}</option>
            <option value="last30Days">${t.last30Days}</option>
            <option value="last90Days">${t.last90Days}</option>
            <option value="thisYear">${t.thisYear}</option>
        `;
    }

    // Update status filter options
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.innerHTML = `
            <option value="all">${t.allStatuses}</option>
            <option value="completed">${t.completed}</option>
            <option value="pending">${t.pending}</option>
            <option value="processing">${t.processing}</option>
            <option value="shipped">${t.shipped}</option>
            <option value="delivered">${t.delivered}</option>
            <option value="cancelled">${t.cancelled}</option>
        `;
    }

    // Update sort options
    const sortBy = document.getElementById('sortBy');
    if (sortBy) {
        sortBy.innerHTML = `
            <option value="newest">${t.sortNewest}</option>
            <option value="oldest">${t.sortOldest}</option>
            <option value="highest">${t.sortHighest}</option>
            <option value="lowest">${t.sortLowest}</option>
        `;
    }

    // Update search placeholder
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.placeholder = t.searchPlaceholder;
    }
}

// Dark mode toggle
function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');

    const toggle = document.getElementById('darkModeToggle');
    if (toggle) {
        toggle.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
}

// Account functions
function showAccount() {
    const slide = document.getElementById('accountSlide');
    if (slide) slide.classList.add('show');
}

function closeAccount() {
    const slide = document.getElementById('accountSlide');
    if (slide) slide.classList.remove('show');
}

// Logout function
function logout() {
    const t = translations[currentLang];
    const logoutBtn = document.getElementById('logoutBtn');
    if (!logoutBtn) return;
    
    if (!confirm(t.logoutConfirm)) return;
    
    const originalText = logoutBtn.textContent;
    logoutBtn.textContent = t.logoutInProgress;
    logoutBtn.disabled = true;
    logoutBtn.style.opacity = '0.7';
    
    localStorage.removeItem('indumilk_currentUser');
    localStorage.removeItem('indumilk_session');
    localStorage.removeItem('indumilk_token');
    localStorage.removeItem('userPreferences');
    
    setTimeout(() => {
        logoutBtn.textContent = t.logoutSuccess;
        logoutBtn.style.backgroundColor = '#4CAF50';
        closeAccount();
        setTimeout(() => { 
            window.location.href = 'index.html'; 
        }, 800);
    }, 1000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', init);